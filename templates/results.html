{% extends "base.html" %}

{% block title %}Resultados - Copiloto de Supervivencia{% endblock %}

{% block content %}
<div class="results-page">
    
    <!-- Header with Version Badge -->
    <div class="results-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
        <h2 style="margin: 0 0 1rem 0; font-size: 2rem;">üìä Tu An√°lisis Financiero 
            {% if snapshot.revision > 1 %}
                <span style="background: rgba(255,255,255,0.2); padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.9rem;">v{{ snapshot.revision }}</span>
            {% endif %}
        </h2>
        <div style="display: flex; gap: 2rem; align-items: center; flex-wrap: wrap;">
            <div class="badge confidence-{{ snapshot.confidence_level }}" style="font-size: 1.1rem; padding: 0.5rem 1.5rem;">
                {{ snapshot.confidence_level | upper }}
            </div>
            <div class="coverage-info" style="font-size: 1rem; opacity: 0.95;">
                üìÖ Cobertura: {{ "%.1f" | format(snapshot.coverage_months) }} meses
            </div>
            <div style="font-size: 0.9rem; opacity: 0.9; margin-left: auto;">
                {{ snapshot.created_at[:16].replace('T', ' ') }}
            </div>
        </div>
    </div>

    <!-- NUEVO: RESUMEN EJECUTIVO ULTRA-CLARO -->
    {% if snapshot.executive_summary %}
    <div class="executive-summary" style="background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); border-radius: 15px; padding: 2.5rem; margin-bottom: 2.5rem; box-shadow: 0 6px 20px rgba(253,203,110,0.4); border-left: 6px solid #e17055;">
        <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem;">
            <span style="font-size: 3.5rem;">üéØ</span>
            <div>
                <h2 style="margin: 0; color: #2d3436; font-size: 1.8rem;">Resumen Ejecutivo</h2>
                <p style="margin: 0.3rem 0 0 0; color: #636e72; font-size: 1rem;">Lo que necesitas saber AHORA</p>
            </div>
        </div>

        <!-- Status Cards Row -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div style="background: white; padding: 1.5rem; border-radius: 10px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">
                    {% if snapshot.executive_summary.status == 'high' %}üî¥
                    {% elif snapshot.executive_summary.status == 'medium' %}üü°
                    {% else %}üü¢{% endif %}
                </div>
                <div style="font-weight: bold; color: #2d3436; font-size: 1.1rem; margin-bottom: 0.3rem;">Estado Global</div>
                <div style="color: 
                    {% if snapshot.executive_summary.status == 'high' %}#d63031
                    {% elif snapshot.executive_summary.status == 'medium' %}#fdcb6e
                    {% else %}#00b894{% endif %}; font-weight: bold; font-size: 1.3rem;">
                    {{ snapshot.executive_summary.status_explanation }}
                </div>
            </div>

            <div style="background: white; padding: 1.5rem; border-radius: 10px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">‚è∞</div>
                <div style="font-weight: bold; color: #2d3436; font-size: 1.1rem; margin-bottom: 0.3rem;">Autonom√≠a</div>
                <div style="color: #0984e3; font-weight: bold; font-size: 2rem;">{{ snapshot.executive_summary.runway_weeks }}</div>
                <div style="color: #636e72; font-size: 0.9rem;">semanas (‚âà {{ snapshot.executive_summary.runway_months }} meses)</div>
            </div>

            <div style="background: white; padding: 1.5rem; border-radius: 10px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">
                    {% if snapshot.executive_summary.min_balance < 0 %}‚ö†Ô∏è{% else %}üí∞{% endif %}
                </div>
                <div style="font-weight: bold; color: #2d3436; font-size: 1.1rem; margin-bottom: 0.3rem;">Saldo M√≠nimo</div>
                <div style="color: {% if snapshot.executive_summary.min_balance < 0 %}#d63031{% else %}#00b894{% endif %}; font-weight: bold; font-size: 1.6rem;">
                    {{ "%.0f" | format(snapshot.executive_summary.min_balance) }}‚Ç¨
                </div>
                <div style="color: #636e72; font-size: 0.85rem;">{{ snapshot.executive_summary.min_balance_date }}</div>
            </div>
        </div>

        <!-- Actions Section -->
        <div style="background: rgba(255,255,255,0.7); padding: 1.8rem; border-radius: 12px; margin-bottom: 1.5rem;">
            <div style="display: grid; gap: 1.5rem;">
                <div>
                    <div style="display: flex; align-items: center; gap: 0.8rem; margin-bottom: 0.8rem;">
                        <span style="background: #d63031; color: white; padding: 0.4rem 0.8rem; border-radius: 6px; font-weight: bold; font-size: 0.85rem;">HOY</span>
                        <span style="font-weight: bold; color: #2d3436; font-size: 1.1rem;">Acci√≥n Prioritaria</span>
                    </div>
                    <p style="margin: 0; color: #2d3436; font-size: 1.05rem; line-height: 1.6;">{{ snapshot.executive_summary.action_today }}</p>
                </div>

                <div>
                    <div style="display: flex; align-items: center; gap: 0.8rem; margin-bottom: 0.8rem;">
                        <span style="background: #fdcb6e; color: #2d3436; padding: 0.4rem 0.8rem; border-radius: 6px; font-weight: bold; font-size: 0.85rem;">ESTA SEMANA</span>
                        <span style="font-weight: bold; color: #2d3436; font-size: 1.1rem;">Siguiente Paso</span>
                    </div>
                    <p style="margin: 0; color: #2d3436; font-size: 1.05rem; line-height: 1.6;">{{ snapshot.executive_summary.action_week }}</p>
                </div>
            </div>
        </div>

        <!-- Missing Data Section -->
        {% if snapshot.executive_summary.missing_data %}
        <div style="background: rgba(255,255,255,0.5); padding: 1.3rem; border-radius: 10px; border: 2px dashed #fdcb6e;">
            <div style="font-weight: bold; color: #e17055; margin-bottom: 0.8rem; display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 1.3rem;">üìä</span> 
                <span style="font-size: 1.05rem;">Datos que mejorar√≠an la precisi√≥n del an√°lisis:</span>
            </div>
            <ul style="margin: 0; padding-left: 1.5rem; color: #2d3436;">
                {% for item in snapshot.executive_summary.missing_data %}
                <li style="margin: 0.4rem 0;">{{ item }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Confidence Note -->
        <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(255,255,255,0.6); border-radius: 8px; border-left: 4px solid #0984e3;">
            <p style="margin: 0; color: #2d3436; font-size: 0.95rem;">
                <strong>üìà Nivel de Confianza:</strong> {{ snapshot.executive_summary.confidence_note }}
            </p>
        </div>
    </div>
    {% endif %}

    <!-- MEJORADO: Data Quality Warnings with Impact -->
    {% if snapshot.warnings %}
    <div style="background: #fff4e6; border: 2px solid #ffa94d; border-radius: 12px; padding: 1.8rem; margin-bottom: 2rem;">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.2rem;">
            <span style="font-size: 2.5rem;">‚ö†Ô∏è</span>
            <div>
                <h4 style="margin: 0; color: #d35400; font-size: 1.3rem;">Avisos sobre Calidad de Datos</h4>
                <p style="margin: 0.3rem 0 0 0; color: #e67e22; font-size: 0.95rem;">Detectamos algunas limitaciones en los datos procesados</p>
            </div>
        </div>

        <div style="display: grid; gap: 1rem;">
            {% for warning in snapshot.warnings %}
            <div style="background: white; padding: 1.2rem; border-radius: 8px; border-left: 4px solid #f39c12;">
                <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem; flex-wrap: wrap;">
                    <div style="flex: 1;">
                        <div style="color: #2d3436; font-size: 1rem; margin-bottom: 0.5rem;">{{ warning }}</div>
                        {% if 'eliminad' in warning.lower() %}
                            {% set count_str = warning.split()[0] %}
                            {% if count_str.isdigit() %}
                                {% set count = count_str | int %}
                                <div style="color: #636e72; font-size: 0.85rem; margin-top: 0.5rem;">
                                    <strong>Impacto:</strong> 
                                    {% if count < 5 %}
                                        <span style="color: #00b894;">üü¢ Bajo</span> - Probablemente errores de formato menores
                                    {% elif count < 20 %}
                                        <span style="color: #fdcb6e;">üü° Medio</span> - Revisar formato del archivo
                                    {% else %}
                                        <span style="color: #d63031;">üî¥ Alto</span> - Puede afectar significativamente las proyecciones
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                    
                    {% if 'eliminad' in warning.lower() or 'ignorad' in warning.lower() %}
                    <div style="background: #fdcb6e; color: #2d3436; padding: 0.4rem 0.8rem; border-radius: 6px; font-weight: bold; font-size: 0.85rem; white-space: nowrap;">
                        ‚ö†Ô∏è REVISAR
                    </div>
                    {% else %}
                    <div style="background: #74b9ff; color: white; padding: 0.4rem 0.8rem; border-radius: 6px; font-weight: bold; font-size: 0.85rem; white-space: nowrap;">
                        ‚ÑπÔ∏è INFO
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 6px; margin-top: 1rem; border: 1px dashed #f39c12;">
            <p style="margin: 0; color: #856404; font-size: 0.9rem;">
                <strong>üí° Recomendaci√≥n:</strong> Si hay muchos datos eliminados, revisa el formato de tus archivos. 
                Aseg√∫rate de que las fechas est√©n en formato DD/MM/YYYY y los importes usen punto o coma como separador decimal.
            </p>
        </div>
    </div>
    {% endif %}


    <!-- Summary Cards Grid -->
    <div class="summary-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <div class="card card-balance" style="background: {% if snapshot.kpis.min_balance < 0 %}#fee;{% else %}#e8f5e9;{% endif %} border-left: 4px solid {% if snapshot.kpis.min_balance < 0 %}#d32f2f;{% else %}#4caf50;{% endif %} padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                <span style="font-size: 2rem;">üí∞</span>
                <h4 style="margin: 0; color: #333;">Saldo M√≠nimo</h4>
            </div>
            <div class="card-value" style="font-size: 2.5rem; font-weight: bold; color: {% if snapshot.kpis.min_balance < 0 %}#d32f2f;{% else %}#2e7d32;{% endif %}">
                {{ "%.0f" | format(snapshot.kpis.min_balance) }}‚Ç¨
            </div>
            <small style="color: #666; font-size: 0.9rem;">üìÖ {{ snapshot.kpis.min_balance_date }}</small>
        </div>

        <div class="card card-risk" style="background: {% if snapshot.kpis.risk_level == 'high' %}#ffebee;{% elif snapshot.kpis.risk_level == 'medium' %}#fff3e0;{% else %}#e3f2fd;{% endif %} border-left: 4px solid {% if snapshot.kpis.risk_level == 'high' %}#c62828;{% elif snapshot.kpis.risk_level == 'medium' %}#ef6c00;{% else %}#1565c0;{% endif %} padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                <span style="font-size: 2rem;">üö¶</span>
                <h4 style="margin: 0; color: #333;">Nivel de Riesgo</h4>
            </div>
            <div class="card-value" style="font-size: 2rem; font-weight: bold; color: {% if snapshot.kpis.risk_level == 'high' %}#c62828;{% elif snapshot.kpis.risk_level == 'medium' %}#ef6c00;{% else %}#1565c0;{% endif %}">
                {{ snapshot.kpis.risk_level | upper }}
            </div>
            <small style="color: #666; font-size: 0.9rem;">‚è∞ {{ snapshot.kpis.runway_weeks }} semanas</small>
        </div>

        <div class="card card-capital" style="background: #fff3e0; border-left: 4px solid #f57c00; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                <span style="font-size: 2rem;">üíµ</span>
                <h4 style="margin: 0; color: #333;">Capital Necesario</h4>
            </div>
            <div class="card-value" style="font-size: 2.5rem; font-weight: bold; color: #e65100;">
                {{ "%.0f" | format(snapshot.survival.capital_total_needed) }}‚Ç¨
            </div>
            <small style="color: #666; font-size: 0.9rem;">Para {{ snapshot.inputs.horizon_months }} meses</small>
        </div>

        <div class="card card-bridge" style="background: {% if snapshot.survival.credit_gap > 0 %}#ffebee;{% else %}#e8f5e9;{% endif %} border-left: 4px solid {% if snapshot.survival.credit_gap > 0 %}#c62828;{% else %}#4caf50;{% endif %} padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                <span style="font-size: 2rem;">üåâ</span>
                <h4 style="margin: 0; color: #333;">Fin. Puente</h4>
            </div>
            <div class="card-value" style="font-size: 2.5rem; font-weight: bold; color: {% if snapshot.survival.credit_gap > 0 %}#c62828;{% else %}#2e7d32;{% endif %}">
                {{ "%.0f" | format(snapshot.survival.financiacion_puente_needed) }}‚Ç¨
            </div>
            {% if snapshot.survival.credit_gap > 0 %}
                <small style="color: #c62828; font-weight: bold;">‚ùå Falta: {{ "%.0f" | format(snapshot.survival.credit_gap) }}‚Ç¨</small>
            {% else %}
                <small style="color: #2e7d32;">‚úÖ Suficiente</small>
            {% endif %}
        </div>
    </div>

    <!-- NUEVO: Capital Breakdown Explained -->
    {% if snapshot.capital_breakdown %}
    <div class="section" style="background: #f7f9fc; border: 2px solid #dfe6e9; border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
        <h3 style="color: #2d3436; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.8rem;">
            <span style="font-size: 1.8rem;">üí∞</span> Desglose del Capital Necesario
            <span style="background: #74b9ff; color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.75rem; font-weight: bold;">EXPLICADO</span>
        </h3>
        
        <div style="display: grid; gap: 1.5rem;">
            <!-- Deficit Max -->
            <div style="background: white; padding: 1.5rem; border-radius: 10px; border-left: 4px solid #e74c3c;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <strong style="color: #2d3436; font-size: 1.1rem;">1Ô∏è‚É£ D√©ficit M√°ximo Acumulado</strong>
                    <span style="font-size: 1.5rem; font-weight: bold; color: #e74c3c;">{{ "%.0f" | format(snapshot.capital_breakdown.deficit_max) }}‚Ç¨</span>
                </div>
                <p style="margin: 0; color: #636e72; font-size: 0.95rem;">{{ snapshot.capital_breakdown.deficit_explanation }}</p>
            </div>

            <!-- Buffer -->
            <div style="background: white; padding: 1.5rem; border-radius: 10px; border-left: 4px solid #f39c12;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <strong style="color: #2d3436; font-size: 1.1rem;">2Ô∏è‚É£ Buffer de Seguridad</strong>
                    <span style="font-size: 1.5rem; font-weight: bold; color: #f39c12;">{{ "%.0f" | format(snapshot.capital_breakdown.buffer) }}‚Ç¨</span>
                </div>
                <p style="margin: 0; color: #636e72; font-size: 0.95rem;">{{ snapshot.capital_breakdown.buffer_explanation }}</p>
            </div>

            <!-- Total -->
            <div style="background: white; padding: 1.5rem; border-radius: 10px; border: 2px solid #3498db; box-shadow: 0 3px 12px rgba(52,152,219,0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <strong style="color: #2d3436; font-size: 1.2rem;">üíé Capital Total Necesario</strong>
                    <span style="font-size: 1.8rem; font-weight: bold; color: #3498db;">{{ "%.0f" | format(snapshot.capital_breakdown.capital_total) }}‚Ç¨</span>
                </div>
                <p style="margin: 0; color: #636e72; font-size: 0.95rem;">{{ snapshot.capital_breakdown.capital_total_explanation }}</p>
            </div>

            <!-- Breakdown: Propio vs Financiaci√≥n -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div style="background: #d4edda; padding: 1.3rem; border-radius: 8px; border-left: 4px solid #28a745;">
                    <div style="font-weight: bold; color: #155724; margin-bottom: 0.5rem;">Tu Aporte (Capital Propio)</div>
                    <div style="font-size: 1.6rem; font-weight: bold; color: #155724;">{{ "%.0f" | format(snapshot.capital_breakdown.capital_propio) }}‚Ç¨</div>
                    <small style="color: #155724; font-size: 0.85rem;">{{ snapshot.capital_breakdown.capital_propio_explanation }}</small>
                </div>
                
                <div style="background: #fff3cd; padding: 1.3rem; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <div style="font-weight: bold; color: #856404; margin-bottom: 0.5rem;">A Financiar (Pr√©stamo/Cr√©dito)</div>
                    <div style="font-size: 1.6rem; font-weight: bold; color: #856404;">{{ "%.0f" | format(snapshot.capital_breakdown.financiacion) }}‚Ç¨</div>
                    <small style="color: #856404; font-size: 0.85rem;">{{ snapshot.capital_breakdown.financiacion_explanation }}</small>
                </div>
            </div>

            <!-- Credit Line Usage & Cost -->
            {% if snapshot.capital_breakdown.credit_max_usage > 0 %}
            <div style="background: #e8f4f8; padding: 1.5rem; border-radius: 10px; border-left: 4px solid #17a2b8;">
                <strong style="color: #0c5460; font-size: 1.1rem; display: block; margin-bottom: 1rem;">üí≥ Uso de L√≠nea de Cr√©dito</strong>
                <div style="display: grid; gap: 0.8rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #0c5460;">Uso m√°ximo estimado:</span>
                        <strong style="color: #17a2b8; font-size: 1.2rem;">{{ "%.0f" | format(snapshot.capital_breakdown.credit_max_usage) }}‚Ç¨</strong>
                    </div>
                    {% if snapshot.capital_breakdown.monthly_interest > 0 %}
                    <div style="background: white; padding: 1rem; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: #636e72;">Coste mensual:</span>
                            <strong style="color: #e74c3c;">{{ "%.0f" | format(snapshot.capital_breakdown.monthly_interest) }}‚Ç¨/mes</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #636e72;">Coste total estimado:</span>
                            <strong style="color: #e74c3c;">{{ "%.0f" | format(snapshot.capital_breakdown.total_interest) }}‚Ç¨</strong>
                        </div>
                        <small style="color: #95a5a6; display: block; margin-top: 0.5rem;">{{ snapshot.capital_breakdown.interest_explanation }}</small>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if snapshot.capital_breakdown.credit_gap > 0 %}
            <div style="background: #f8d7da; padding: 1.3rem; border-radius: 8px; border: 2px solid #f5c6cb;">
                <strong style="color: #721c24; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.3rem;">‚ö†Ô∏è</span> BRECHA DE FINANCIACI√ìN
                </strong>
                <p style="margin: 0; color: #721c24; font-size: 1rem;">
                    Tu l√≠nea de cr√©dito actual es insuficiente. 
                    <strong style="font-size: 1.2rem;">Te faltan {{ "%.0f" | format(snapshot.capital_breakdown.credit_gap) }}‚Ç¨</strong> de capacidad de financiaci√≥n.
                </p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- MEJORADO: Cashflow Table with Filters (MINIMIZADO por defecto) -->
    <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
            <h3 style="margin: 0;">üíπ Proyecci√≥n de Cashflow</h3>
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="toggleMovement" onchange="filterCashflow()" style="width: 18px; height: 18px;">
                    <span style="font-size: 0.95rem;">Solo con movimiento</span>
                </label>
            </div>
        </div>
        
        <div style="border-radius: 8px; border: 1px solid var(--border-color); overflow: hidden;">
            <table class="cashflow-table" id="cashflowTable" style="width: 100%;">
                <thead style="position: sticky; top: 0; background: var(--accent-primary); color: white; z-index: 10;">
                    <tr>
                        <th style="padding: 12px;">Per√≠odo</th>
                        <th style="padding: 12px;">Ingresos</th>
                        <th style="padding: 12px;">Pagos</th>
                        <th style="padding: 12px;">Neto</th>
                        <th style="padding: 12px;">Balance</th>
                    </tr>
                </thead>
                <tbody id="cashflowTableBody">
                    {% for row in cashflow %}
                    <tr data-inflows="{{ row.inflows }}" 
                        data-outflows="{{ row.outflows }}" 
                        data-row-index="{{ loop.index0 }}"
                        class="cashflow-row{% if loop.index0 >= 10 %} hidden-row{% endif %}"
                        {% if row.balance < 0 %}data-balance-status="negative"
                        {% elif row.below_safety %}data-balance-status="warning"
                        {% endif %}
                        style="{% if loop.index0 % 2 == 0 %}background: var(--bg-card-secondary);{% endif %} {% if loop.index0 >= 10 %}display: none;{% endif %}">
                        <td style="padding: 12px;"><strong>{{ row.period_start }}</strong></td>
                        <td class="positive" style="padding: 12px;">+{{ "%.2f" | format(row.inflows) }}‚Ç¨</td>
                        <td class="negative" style="padding: 12px;">-{{ "%.2f" | format(row.outflows) }}‚Ç¨</td>
                        <td {% if row.net < 0 %}class="negative"{% else %}class="positive"{% endif %} style="font-weight: bold; padding: 12px;">
                            {{ "%.2f" | format(row.net) }}‚Ç¨
                        </td>
                        <td class="balance-cell" style="font-weight: bold; font-size: 1.05rem; padding: 12px;">{{ "%.2f" | format(row.balance) }}‚Ç¨</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div style="margin-top: 1rem; text-align: center;">
            <button onclick="toggleCashflowExpansion()" id="expandCashflowBtn" class="btn btn-primary" style="padding: 0.8rem 1.5rem; font-size: 1rem;">
                üìä Ver Proyecci√≥n Completa ({{ cashflow|length }} per√≠odos)
            </button>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 0.5rem;" id="cashflowHint">
                Mostrando 10 de {{ cashflow|length }} per√≠odos
            </p>
        </div>
    </div>

    <script>
    let cashflowExpanded = false;
    
    function toggleCashflowExpansion() {
        const rows = document.querySelectorAll('.cashflow-row');
        const btn = document.getElementById('expandCashflowBtn');
        const hint = document.getElementById('cashflowHint');
        const totalRows = rows.length;
        
        cashflowExpanded = !cashflowExpanded;
        
        if (cashflowExpanded) {
            // Mostrar TODAS las filas
            rows.forEach(row => {
                row.style.display = '';
            });
            btn.innerHTML = 'üìï Minimizar Proyecci√≥n';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-secondary');
            hint.textContent = `Mostrando ${totalRows} de ${totalRows} per√≠odos`;
        } else {
            // Mostrar SOLO primeras 10
            rows.forEach((row, index) => {
                if (index >= 10) {
                    row.style.display = 'none';
                } else {
                    row.style.display = '';
                }
            });
            btn.innerHTML = 'üìä Ver Proyecci√≥n Completa (' + totalRows + ' per√≠odos)';
            btn.classList.remove('btn-secondary');
            btn.classList.add('btn-primary');
            hint.textContent = `Mostrando 10 de ${totalRows} per√≠odos`;
        }
    }
    
    function filterCashflow() {
        const checkbox = document.getElementById('toggleMovement');
        const rows = document.querySelectorAll('.cashflow-row');
        
        rows.forEach((row, index) => {
            const inflows = parseFloat(row.dataset.inflows) || 0;
            const outflows = parseFloat(row.dataset.outflows) || 0;
            const hasMovement = Math.abs(inflows) >= 1 || Math.abs(outflows) >= 1;
            
            if (checkbox.checked) {
                if (!hasMovement) {
                    row.style.display = 'none';
                } else if (!cashflowExpanded && index >= 10) {
                    row.style.display = 'none';
                } else {
                    row.style.display = '';
                }
            } else {
                if (!cashflowExpanded && index >= 10) {
                    row.style.display = 'none';
                } else {
                    row.style.display = '';
                }
            }
        });
    }
    </script>

    <!-- MEJORADO: Scenarios with Explanations -->
    <div class="section">
        <h3 style="margin-bottom: 1.5rem;">üîÆ Comparaci√≥n de Escenarios</h3>
        
        {% if snapshot.scenario_explanations %}
        <div style="background: #eef2f7; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; border-left: 4px solid #5f27cd;">
            <h4 style="color: #341f97; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                <span>‚ÑπÔ∏è</span> ¬øQu√© Cambia en Cada Escenario?
            </h4>
            
            <div style="display: grid; gap: 1rem;">
                <div style="background: white; padding: 1rem; border-radius: 8px;">
                    <strong style="color: #2d3436;">‚ö™ Base:</strong> 
                    <span style="color: #636e72;">{{ snapshot.scenario_explanations.base_assumptions }}</span>
                </div>
                
                <div style="background: white; padding: 1rem; border-radius: 8px;">
                    <strong style="color: #d63031;">üî¥ Conservador:</strong> 
                    <span style="color: #636e72;">{{ snapshot.scenario_explanations.conservative_changes }}</span>
                </div>
                
                <div style="background: white; padding: 1rem; border-radius: 8px;">
                    <strong style="color: #00b894;">üü¢ Optimista:</strong> 
                    <span style="color: #636e72;">{{ snapshot.scenario_explanations.optimistic_changes }}</span>
                </div>
            </div>
            
            {% if not snapshot.scenario_explanations.are_different %}
            <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin-top: 1rem; border: 2px dashed #ffc107;">
                <p style="margin: 0; color: #856404;">
                    <strong>‚ÑπÔ∏è Nota:</strong> {{ snapshot.scenario_explanations.explanation }}
                </p>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <div class="table-container">
            <table class="scenarios-table">
                <thead style="position: sticky; top: 0; background: #5f27cd; color: white; z-index: 10;">
                    <tr>
                        <th>Escenario</th>
                        <th>Saldo M√≠n.</th>
                        <th>Riesgo</th>
                        <th>Runway</th>
                        <th>Capital</th>
                        <th>Fin. Puente</th>
                        <th>Brecha</th>
                    </tr>
                </thead>
                <tbody>
                    {% for scenario in scenarios_comparison %}
                    <tr style="{% if loop.index0 % 2 == 0 %}background: #f8f9fa;{% endif %}">
                        <td><strong>{{ scenario.scenario }}</strong></td>
                        <td class="{% if scenario.min_balance < 0 %}negative{% endif %}" style="font-weight: bold;">
                            {{ "%.0f" | format(scenario.min_balance) }}‚Ç¨
                        </td>
                        <td class="risk-{{ scenario.risk_level }}" style="font-weight: bold;">{{ scenario.risk_level | upper }}</td>
                        <td>{{ scenario.runway_weeks }}s</td>
                        <td>{{ "%.0f" | format(scenario.capital_needed) }}‚Ç¨</td>
                        <td>{{ "%.0f" | format(scenario.bridge_financing) }}‚Ç¨</td>
                        <td class="{% if scenario.credit_gap > 0 %}negative{% endif %}" style="font-weight: bold;">
                            {{ "%.0f" | format(scenario.credit_gap) }}‚Ç¨
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    </div>

    <!-- MEJORADO: Alerts with Enhanced Display -->
    <div class="section">
        <h3 style="margin-bottom: 1.5rem;">üö® Alertas Detectadas</h3>
        {% if snapshot.alerts %}
            <div class="alerts-list" style="display: grid; gap: 1.5rem;">
                {% for alert in snapshot.alerts %}
                <div class="alert-item severity-{{ alert.severity }}" style="
                    background: {% if alert.severity == 'high' %}#ffebee{% elif alert.severity == 'medium' %}#fff3e0{% else %}#e8f5e9{% endif %};
                    border-left: 6px solid {% if alert.severity == 'high' %}#d32f2f{% elif alert.severity == 'medium' %}#f57c00{% else %}#388e3c{% endif %};
                    padding: 1.5rem;
                    border-radius: 10px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                        <h4 style="margin: 0; color: #2d3436; font-size: 1.2rem; flex: 1;">{{ alert.title }}</h4>
                        <span style="
                            background: {% if alert.severity == 'high' %}#d32f2f{% elif alert.severity == 'medium' %}#f57c00{% else %}#388e3c{% endif %};
                            color: white;
                            padding: 0.4rem 1rem;
                            border-radius: 20px;
                            font-weight: bold;
                            font-size: 0.85rem;">
                            {{ alert.severity | upper }}
                        </span>
                    </div>
                    
                    <p style="margin: 0 0 1rem 0; color: #2d3436; font-size: 1.05rem; line-height: 1.6;">{{ alert.message }}</p>
                    
                    <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                        <strong style="color: #636e72; font-size: 0.9rem;">üìä Evidencia:</strong>
                        <p style="margin: 0.3rem 0 0 0; color: #636e72; font-size: 0.95rem;">{{ alert.evidence }}</p>
                    </div>
                    
                    <div style="background: {% if alert.severity == 'high' %}#fce4ec{% elif alert.severity == 'medium' %}#fff8e1{% else %}#f1f8e9{% endif %}; padding: 1.2rem; border-radius: 8px; border: 2px solid {% if alert.severity == 'high' %}#f06292{% elif alert.severity == 'medium' %}#ffb74d{% else %}#aed581{% endif %};">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.3rem;">üí°</span>
                            <strong style="color: #2d3436; font-size: 1.05rem;">Acci√≥n Recomendada:</strong>
                        </div>
                        <p style="margin: 0; color: #2d3436; font-size: 1rem; line-height: 1.6;">{{ alert.recommended_action }}</p>
                    </div>
                    
                    {% if events_available %}
                    <details style="margin-top: 1rem;">
                        <summary style="cursor: pointer; color: #0984e3; font-weight: 600; padding: 0.5rem; background: rgba(9,132,227,0.1); border-radius: 6px;">
                            üîç Ver transacciones relacionadas (drill-down)
                        </summary>
                        <div style="margin-top: 0.8rem; padding: 1rem; background: white; border-radius: 6px; font-size: 0.9rem;">
                            <em style="color: #636e72;">Funcionalidad de drill-down en desarrollo. Mostrar√° las transacciones espec√≠ficas que causaron esta alerta.</em>
                        </div>
                    </details>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div style="background: #d4edda; border: 2px solid #c3e6cb; padding: 2rem; border-radius: 10px; text-align: center;">
                <span style="font-size: 3rem; display: block; margin-bottom: 1rem;">‚úÖ</span>
                <p style="margin: 0; color: #155724; font-size: 1.2rem; font-weight: 600;">No se detectaron alertas cr√≠ticas</p>
                <p style="margin: 0.5rem 0 0 0; color: #155724;">Tu situaci√≥n financiera proyectada est√° dentro de par√°metros saludables.</p>
            </div>
        {% endif %}
    </div>

    <!-- MEJORADO: Action Plan with Interactive Checklist -->
    <div class="section">
        <h3 style="margin-bottom: 1.5rem;">üìã Plan de Acci√≥n Priorizado</h3>
        
        <div style="display: grid; gap: 2rem;">
            <!-- Immediate 48h -->
            <div style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); padding: 2rem; border-radius: 12px; border-left: 6px solid #d32f2f; box-shadow: 0 3px 10px rgba(211,47,47,0.2);">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                    <span style="font-size: 2.5rem;">üî¥</span>
                    <div>
                        <h4 style="margin: 0; color: #b71c1c; font-size: 1.4rem;">Inmediato (48 horas)</h4>
                        <p style="margin: 0.3rem 0 0 0; color: #c62828; font-size: 0.95rem;">Acciones urgentes que no pueden esperar</p>
                    </div>
                </div>
                
                {% if snapshot.action_plan.immediate_48h %}
                    {% for action in snapshot.action_plan.immediate_48h %}
                    <div style="background: white; padding: 1.2rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #d32f2f;">
                        <label style="display: flex; gap: 1rem; cursor: pointer; align-items: start;">
                            <input type="checkbox" style="margin-top: 0.3rem; width: 20px; height: 20px; flex-shrink: 0;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: #2d3436; font-size: 1.05rem; margin-bottom: 0.5rem;">{{ action.action }}</div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; color: #636e72; font-size: 0.9rem;">
                                    <span style="font-weight: 600;">üí° Por qu√©:</span>
                                    <span>{{ action.reason }}</span>
                                </div>
                            </div>
                        </label>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: #c62828; font-style: italic; margin: 0;">No hay acciones urgentes detectadas.</p>
                {% endif %}
            </div>

            <!-- Short term 7-14d -->
            <div style="background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); padding: 2rem; border-radius: 12px; border-left: 6px solid #f57c00; box-shadow: 0 3px 10px rgba(245,124,0,0.2);">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                    <span style="font-size: 2.5rem;">üü°</span>
                    <div>
                        <h4 style="margin: 0; color: #e65100; font-size: 1.4rem;">Corto Plazo (7-14 d√≠as)</h4>
                        <p style="margin: 0.3rem 0 0 0; color: #f57c00; font-size: 0.95rem;">Acciones importantes para esta semana y la pr√≥xima</p>
                    </div>
                </div>
                
                {% if snapshot.action_plan.short_term_7_14d %}
                    {% for action in snapshot.action_plan.short_term_7_14d %}
                    <div style="background: white; padding: 1.2rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #f57c00;">
                        <label style="display: flex; gap: 1rem; cursor: pointer; align-items: start;">
                            <input type="checkbox" style="margin-top: 0.3rem; width: 20px; height: 20px; flex-shrink: 0;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: #2d3436; font-size: 1.05rem; margin-bottom: 0.5rem;">{{ action.action }}</div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; color: #636e72; font-size: 0.9rem;">
                                    <span style="font-weight: 600;">üí° Por qu√©:</span>
                                    <span>{{ action.reason }}</span>
                                </div>
                            </div>
                        </label>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: #e65100; font-style: italic; margin: 0;">No hay acciones a corto plazo.</p>
                {% endif %}
            </div>

            <!-- Medium term 30-90d -->
            <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 2rem; border-radius: 12px; border-left: 6px solid #388e3c; box-shadow: 0 3px 10px rgba(56,142,60,0.2);">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                    <span style="font-size: 2.5rem;">üü¢</span>
                    <div>
                        <h4 style="margin: 0; color: #1b5e20; font-size: 1.4rem;">Mediano Plazo (30-90 d√≠as)</h4>
                        <p style="margin: 0.3rem 0 0 0; color: #388e3c; font-size: 0.95rem;">Mejoras estructurales y planificaci√≥n a futuro</p>
                    </div>
                </div>
                
                {% if snapshot.action_plan.medium_term_30_90d %}
                    {% for action in snapshot.action_plan.medium_term_30_90d %}
                    <div style="background: white; padding: 1.2rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #388e3c;">
                        <label style="display: flex; gap: 1rem; cursor: pointer; align-items: start;">
                            <input type="checkbox" style="margin-top: 0.3rem; width: 20px; height: 20px; flex-shrink: 0;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: #2d3436; font-size: 1.05rem; margin-bottom: 0.5rem;">{{ action.action }}</div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; color: #636e72; font-size: 0.9rem;">
                                    <span style="font-weight: 600;">üí° Por qu√©:</span>
                                    <span>{{ action.reason }}</span>
                                </div>
                            </div>
                        </label>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: #1b5e20; font-style: italic; margin: 0;">No hay acciones a mediano plazo.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- MEJORADO: LLM Report in Memo Format with Copy Button -->
    <div class="section report-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
            <h3 style="margin: 0;">üìÑ Informe Ejecutivo
                {% if snapshot.report_source == 'llm' %}
                    <span style="background: #667eea; color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.75rem; font-weight: bold; margin-left: 0.5rem;">IA</span>
                {% else %}
                    <span style="background: #6c757d; color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.75rem; font-weight: bold; margin-left: 0.5rem;">RULES-BASED</span>
                {% endif %}
            </h3>
            <div style="display: flex; gap: 0.8rem;">
                <button onclick="toggleFullReport()" style="background: #74b9ff; color: white; padding: 0.6rem 1.2rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                    <span id="toggleIcon">üìñ</span> <span id="toggleText">Ver Completo</span>
                </button>
                <button onclick="copyReport()" style="background: #00b894; color: white; padding: 0.6rem 1.2rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                    üìã Copiar
                </button>
            </div>
        </div>

        <!-- Memo Format Summary (Always Visible) -->
        <div id="memoSummary" style="background: white; padding: 2rem; border-radius: 12px; border: 2px solid #dfe6e9; margin-bottom: 1.5rem;">
            <div style="border-bottom: 2px solid #dfe6e9; padding-bottom: 1rem; margin-bottom: 1.5rem;">
                <div style="color: #636e72; font-size: 0.9rem; margin-bottom: 0.3rem;">MEMOR√ÅNDUM EJECUTIVO</div>
                <div style="font-weight: bold; color: #2d3436; font-size: 1.1rem;">An√°lisis Financiero - {{ snapshot.created_at[:10] }}</div>
            </div>

            <!-- Extract key bullets from report (simplified version) -->
            <div style="display: grid; gap: 1.5rem;">
                <div>
                    <div style="background: #dfe6e9; padding: 0.5rem 1rem; border-radius: 6px; display: inline-block; margin-bottom: 0.8rem; font-weight: bold; color: #2d3436;">
                        üìä SITUACI√ìN
                    </div>
                    <ul style="margin: 0; padding-left: 1.5rem; color: #2d3436; line-height: 1.8;">
                        <li>Saldo m√≠nimo proyectado: <strong>{{ "%.0f" | format(snapshot.kpis.min_balance) }}‚Ç¨</strong> ({{ snapshot.kpis.min_balance_date }})</li>
                        <li>Nivel de riesgo: <strong style="color: {% if snapshot.kpis.risk_level == 'high' %}#d63031{% elif snapshot.kpis.risk_level == 'medium' %}#f39c12{% else %}#00b894{% endif %}">{{ snapshot.kpis.risk_level | upper }}</strong></li>
                        <li>Autonom√≠a financiera: <strong>{{ snapshot.kpis.runway_weeks }} semanas</strong> (‚âà {{ (snapshot.kpis.runway_weeks / 4.33) | round(1) }} meses)</li>
                    </ul>
                </div>

                <div>
                    <div style="background: #fab1a0; padding: 0.5rem 1rem; border-radius: 6px; display: inline-block; margin-bottom: 0.8rem; font-weight: bold; color: #2d3436;">
                        ‚ö†Ô∏è RIESGOS
                    </div>
                    <ul style="margin: 0; padding-left: 1.5rem; color: #2d3436; line-height: 1.8;">
                        {% if snapshot.alerts %}
                            {% for alert in snapshot.alerts[:3] %}
                            <li>{{ alert.title }}</li>
                            {% endfor %}
                            {% if snapshot.alerts|length > 3 %}
                            <li><em>+ {{ snapshot.alerts|length - 3 }} alertas adicionales</em></li>
                            {% endif %}
                        {% else %}
                            <li>‚úÖ Sin riesgos cr√≠ticos detectados</li>
                        {% endif %}
                    </ul>
                </div>

                <div>
                    <div style="background: #a29bfe; padding: 0.5rem 1rem; border-radius: 6px; display: inline-block; margin-bottom: 0.8rem; font-weight: bold; color: white;">
                        üéØ ACCIONES PRIORITARIAS
                    </div>
                    <ul style="margin: 0; padding-left: 1.5rem; color: #2d3436; line-height: 1.8;">
                        {% if snapshot.action_plan.immediate_48h %}
                            {% for action in snapshot.action_plan.immediate_48h[:3] %}
                            <li>{{ action.action }}</li>
                            {% endfor %}
                        {% else %}
                            <li>‚úÖ Mantener seguimiento regular del cashflow</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- Full Report (Collapsible) -->
        <div id="fullReport" style="display: none;">
            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); padding: 3rem; border-radius: 16px; border: 2px solid #e0e7ff; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.1);">
                <div style="border-bottom: 3px solid #667eea; padding-bottom: 1rem; margin-bottom: 2.5rem;">
                    <div style="color: #667eea; font-size: 0.85rem; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 0.5rem;">üìä Informe Detallado</div>
                    <h2 style="margin: 0; color: #2d3436; font-size: 1.8rem; font-weight: 700;">An√°lisis Completo de Cashflow</h2>
                </div>
                
                <div id="reportContent" class="report-content" style="color: #2d3436; font-size: 1.05rem;">
                    {{ current_report | format_report | safe }}
                </div>
            </div>
        </div>
    </div>

    <script>
    function toggleFullReport() {
        const fullReport = document.getElementById('fullReport');
        const toggleIcon = document.getElementById('toggleIcon');
        const toggleText = document.getElementById('toggleText');
        
        if (fullReport.style.display === 'none') {
            fullReport.style.display = 'block';
            // Smooth scroll to report
            setTimeout(() => {
                fullReport.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
            toggleIcon.textContent = 'üìï';
            toggleText.textContent = 'Ver Resumen';
        } else {
            fullReport.style.display = 'none';
            toggleIcon.textContent = 'üìñ';
            toggleText.textContent = 'Ver Completo';
        }
    }

    function copyReport() {
        const memoText = document.getElementById('memoSummary').innerText;
        const fullText = document.getElementById('fullReport').innerText;
        const textToCopy = memoText + '\n\n--- INFORME COMPLETO ---\n\n' + fullText;
        
        navigator.clipboard.writeText(textToCopy).then(() => {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úÖ Copiado';
            btn.style.background = '#00b894';
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = '#00b894';
            }, 2000);
        }).catch(err => {
            alert('Error al copiar: ' + err);
        });
    }
    </script>

    <!-- Mostrar si hubo refinamiento (NUEVO) -->
    {% if snapshot.refine_answers and snapshot.refine_answers|length > 0 and snapshot.revision > 1 %}
    <div style="background: #fff9e6; border: 2px solid #ffd93d; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <span style="font-size: 2rem;">üîÑ</span>
            <div>
                <h4 style="margin: 0; color: #2d3436; font-size: 1.2rem;">An√°lisis Refinado con Tus Respuestas</h4>
                <p style="margin: 0.3rem 0 0 0; color: #636e72; font-size: 0.95rem;">Este es el informe v{{ snapshot.revision }} personalizado seg√∫n tu contexto</p>
            </div>
        </div>

        <div style="background: white; padding: 1.2rem; border-radius: 8px; margin-bottom: 1rem;">
            <strong style="color: #2d3436; display: block; margin-bottom: 0.8rem;">üìù Contexto Proporcionado:</strong>
            <div style="display: grid; gap: 0.6rem; color: #636e72; font-size: 0.95rem;">
                {% if snapshot.refine_answers.priorities %}
                <div><strong>Prioridades:</strong> {{ snapshot.refine_answers.priorities | join(', ') }}</div>
                {% endif %}
                {% if snapshot.refine_answers.timing %}
                <div><strong>Timing de cobros:</strong> {{ snapshot.refine_answers.timing }}</div>
                {% endif %}
                {% if snapshot.refine_answers.control %}
                <div><strong>Control financiero:</strong> {{ snapshot.refine_answers.control }}</div>
                {% endif %}
                {% if snapshot.refine_answers.upcoming_cashflows %}
                <div><strong>Movimientos futuros:</strong> {{ snapshot.refine_answers.upcoming_cashflows }}</div>
                {% endif %}
                {% if snapshot.refine_answers.can_renegotiate %}
                <div><strong>Puede renegociar con proveedores:</strong> {{ snapshot.refine_answers.can_renegotiate }}</div>
                {% endif %}
            </div>
        </div>

        <div style="background: #e8f4f8; padding: 1rem; border-radius: 6px; border-left: 4px solid #0984e3;">
            <p style="margin: 0; color: #0c5460; font-size: 0.95rem;">
                <strong>‚ÑπÔ∏è Importante:</strong> Los n√∫meros del an√°lisis (cashflow, capital necesario, etc.) NO cambiaron. 
                Solo se ajustaron las recomendaciones y el enfoque del informe para adaptarse mejor a tu situaci√≥n.
            </p>
        </div>
    </div>
    {% endif %}

    <!-- Guided Questions (Post-Analysis) -->
            Cu√©ntanos un poco m√°s sobre tu situaci√≥n. Esto nos ayudar√° a darte recomendaciones m√°s ajustadas a tu realidad. 
            <span style="color: #718096; font-style: italic;">(Los n√∫meros no cambiar√°n, solo las sugerencias üòâ)</span>
        </p>
        
        <form action="{{ url_for('refine', snapshot_id=snapshot.snapshot_id) }}" method="post" class="refine-form">
            
            <div class="form-group" style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #4299e1;">
                <label style="color: #2d3748; font-size: 16px; font-weight: 600; display: block; margin-bottom: 12px;">
                    üéØ ¬øQu√© es lo m√°s importante para ti ahora mismo?
                </label>
                <p style="color: #718096; font-size: 14px; margin-bottom: 12px;">Puedes marcar varias opciones</p>
                <div class="checkbox-grid" style="display: grid; gap: 10px;">
                    <label style="display: flex; align-items: center; padding: 10px; border-radius: 5px; cursor: pointer; transition: background 0.2s;">
                        <input type="checkbox" name="priorities" value="supervivencia" style="margin-right: 10px; width: 18px; height: 18px;"> 
                        <span style="color: #2d3748;">üö® <strong>Sobrevivir</strong> - Llegar a fin de mes sin apuros</span>
                    </label>
                    <label style="display: flex; align-items: center; padding: 10px; border-radius: 5px; cursor: pointer; transition: background 0.2s;">
                        <input type="checkbox" name="priorities" value="crecimiento" style="margin-right: 10px; width: 18px; height: 18px;"> 
                        <span style="color: #2d3748;">üìà <strong>Crecer</strong> - Invertir y expandir el negocio</span>
                    </label>
                    <label style="display: flex; align-items: center; padding: 10px; border-radius: 5px; cursor: pointer; transition: background 0.2s;">
                        <input type="checkbox" name="priorities" value="estabilidad" style="margin-right: 10px; width: 18px; height: 18px;"> 
                        <span style="color: #2d3748;">‚öñÔ∏è <strong>Estabilizar</strong> - Tener tranquilidad financiera</span>
                    </label>
                    <label style="display: flex; align-items: center; padding: 10px; border-radius: 5px; cursor: pointer; transition: background 0.2s;">
                        <input type="checkbox" name="priorities" value="reducir_deuda" style="margin-right: 10px; width: 18px; height: 18px;"> 
                        <span style="color: #2d3748;">üí≥ <strong>Reducir deudas</strong> - Bajar pr√©stamos y cr√©ditos</span>
                    </label>
                </div>
            </div>

            <div class="form-group" style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #48bb78;">
                <label style="color: #2d3748; font-size: 16px; font-weight: 600; display: block; margin-bottom: 12px;">
                    ‚è∞ ¬øC√≥mo te pagan tus clientes normalmente?
                </label>
                <p style="color: #718096; font-size: 14px; margin-bottom: 12px;">Esto nos ayuda a saber si tus proyecciones son realistas</p>
                <select name="timing" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; color: #2d3748; background: white;">
                    <option value="">üëâ Selecciona una opci√≥n...</option>
                    <option value="puntual">‚úÖ A tiempo - Me pagan en las fechas acordadas</option>
                    <option value="retrasos_leves">üü° Con peque√±os retrasos (1-2 semanas tarde)</option>
                    <option value="retrasos_graves">üî¥ Con retrasos grandes (m√°s de 1 mes tarde)</option>
                    <option value="impredecible">üé≤ Es un caos - Nunca s√© cu√°ndo cobro</option>
                </select>
            </div>

            <div class="form-group" style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ed8936;">
                <label style="color: #2d3748; font-size: 16px; font-weight: 600; display: block; margin-bottom: 12px;">
                    üéÆ ¬øQu√© tanto control tienes sobre tu dinero?
                </label>
                <p style="color: #718096; font-size: 14px; margin-bottom: 12px;">¬øPuedes predecir cu√°ndo entra y sale dinero?</p>
                <div class="radio-group" style="display: grid; gap: 10px;">
                    <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="control" value="alto" style="margin-right: 12px; width: 18px; height: 18px;"> 
                        <span style="color: #2d3748;"><strong>üí™ Alto</strong> - S√© exactamente qu√© va a pasar</span>
                    </label>
                    <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="control" value="medio" style="margin-right: 12px; width: 18px; height: 18px;"> 
                        <span style="color: #2d3748;"><strong>ü§∑ Medio</strong> - Tengo una idea general</span>
                    </label>
                    <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="control" value="bajo" style="margin-right: 12px; width: 18px; height: 18px;"> 
                        <span style="color: #2d3748;"><strong>üò∞ Bajo</strong> - Es impredecible, me estresa</span>
                    </label>
                </div>
            </div>

            {% if snapshot.kpis.risk_level == 'high' %}
            <div class="form-group" style="background: #fff5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #f56565;">
                <label style="color: #c53030; font-size: 16px; font-weight: 600; display: block; margin-bottom: 12px;">
                    üîÆ ¬øViene algo grande que no vemos en los datos?
                </label>
                <p style="color: #742a2a; font-size: 14px; margin-bottom: 12px;">
                    Si esperas cobros importantes o tienes que hacer pagos grandes pronto, cu√©ntanos aqu√≠
                </p>
                <textarea name="upcoming_cashflows" rows="4" 
                          style="width: 100%; padding: 12px; border: 2px solid #fc8181; border-radius: 8px; font-size: 15px; color: #2d3748; font-family: inherit;"
                          placeholder="Por ejemplo: 'Mi cliente grande me paga 15.000‚Ç¨ en 2 semanas' o 'Tengo que pagar 8.000‚Ç¨ de impuestos el d√≠a 20'"></textarea>
            </div>
            {% endif %}

            {% if snapshot.survival.financiacion_puente_needed > 0 %}
            <div class="form-group" style="background: #fffaf0; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ed8936;">
                <label style="color: #c05621; font-size: 16px; font-weight: 600; display: block; margin-bottom: 12px;">
                    ü§ù ¬øPodr√≠as hablar con tus proveedores para pagar m√°s tarde?
                </label>
                <p style="color: #7c2d12; font-size: 14px; margin-bottom: 12px;">
                    A veces negociar 15-30 d√≠as extra marca la diferencia
                </p>
                <div class="radio-group" style="display: grid; gap: 10px;">
                    <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #fbd38d; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="can_renegotiate" value="si" style="margin-right: 12px; width: 18px; height: 18px;"> 
                        <span style="color: #2d3748;"><strong>‚úÖ S√≠</strong> - Tengo buena relaci√≥n con ellos</span>
                    </label>
                    <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #fbd38d; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="can_renegotiate" value="no" style="margin-right: 12px; width: 18px; height: 18px;"> 
                        <span style="color: #2d3748;"><strong>‚ùå No</strong> - Es complicado o imposible</span>
                    </label>
                    <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #fbd38d; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="can_renegotiate" value="algunos" style="margin-right: 12px; width: 18px; height: 18px;"> 
                        <span style="color: #2d3748;"><strong>üîÑ Algunos</strong> - Con algunos s√≠, con otros no</span>
                    </label>
                </div>
            </div>
            {% endif %}

            <button type="submit" class="btn btn-secondary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);">
                üöÄ Actualizar Mis Recomendaciones
            </button>
        </form>
    </div>

    <!-- Downloads -->
    <div class="section downloads-section">
        <h3>üíæ Descargas</h3>
        <div class="download-buttons">
            <a href="{{ url_for('download', snapshot_id=snapshot.snapshot_id, file_type='txt') }}" 
               class="btn btn-download">üìÑ Descargar Informe TXT</a>
            <a href="{{ url_for('download', snapshot_id=snapshot.snapshot_id, file_type='md') }}" 
               class="btn btn-download">üìù Descargar Informe MD</a>
            <a href="{{ url_for('download', snapshot_id=snapshot.snapshot_id, file_type='csv_cashflow') }}" 
               class="btn btn-download">üìä Descargar Cashflow CSV</a>
            <a href="{{ url_for('download', snapshot_id=snapshot.snapshot_id, file_type='csv_scenarios') }}" 
               class="btn btn-download">üîÆ Descargar Escenarios CSV</a>
        </div>
    </div>

    <!-- Navigation -->
    <div class="section navigation-section">
        <a href="{{ url_for('index') }}" class="btn btn-primary">üÜï Nuevo An√°lisis</a>
        <a href="{{ url_for('history') }}" class="btn btn-secondary">üìö Ver Historial</a>
    </div>
</div>
{% endblock %}
