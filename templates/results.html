{% extends "base.html" %}

{% block title %}Resultados - Copiloto de Supervivencia{% endblock %}

{% block content %}
<div class="results-page">
    
    <!-- Header with Confidence -->
    <div class="results-header">
        <h2>üìä An√°lisis de Supervivencia Completado</h2>
        <div class="confidence-badge">
            <div class="badge confidence-{{ snapshot.confidence_level }}">
                Confianza: {{ snapshot.confidence_level | upper }}
            </div>
            <div class="coverage-info">
                Cobertura: {{ "%.1f" | format(snapshot.coverage_months) }} meses
            </div>
        </div>
        <p class="analysis-date">Generado: {{ snapshot.created_at }}</p>
    </div>

    <!-- Data Limitations Section -->
    <div class="limitations-section">
        <h4>üìã Alcance y Limitaciones de Este An√°lisis</h4>
        <div class="limitations-grid">
            <div class="limitation-item">
                <strong>Cobertura de datos:</strong>
                <span>{{ "%.1f" | format(snapshot.coverage_months) }} meses de extracto bancario</span>
                {% if snapshot.coverage_months < 3 %}
                    <p class="limitation-note">‚ö†Ô∏è Con menos de 3 meses no podemos identificar patrones estacionales ni tendencias fiables.</p>
                {% elif snapshot.coverage_months < 6 %}
                    <p class="limitation-note">‚ÑπÔ∏è Con 3-6 meses tenemos una vista parcial. Recomendamos al menos 6 meses para mayor precisi√≥n.</p>
                {% else %}
                    <p class="limitation-note positive">‚úÖ Cobertura suficiente para identificar patrones y tendencias.</p>
                {% endif %}
            </div>
            
            <div class="limitation-item">
                <strong>Datos futuros:</strong>
                {% if snapshot.quality_metrics.has_future_collections or snapshot.quality_metrics.has_future_payments %}
                    <span>‚úÖ Incluye facturas pendientes</span>
                    <p class="limitation-note positive">Los escenarios conservador y optimista son m√°s precisos.</p>
                {% else %}
                    <span>‚ö†Ô∏è Sin facturas pendientes</span>
                    <p class="limitation-note">Los escenarios futuros se basan solo en hist√≥rico. Sube facturas pendientes para mayor precisi√≥n.</p>
                {% endif %}
            </div>
            
            <div class="limitation-item">
                <strong>Nivel de confianza:</strong>
                <span class="confidence-{{ snapshot.confidence_level }}">{{ snapshot.confidence_level | upper }}</span>
                {% if snapshot.confidence_level == 'low' %}
                    <p class="limitation-note">‚ö†Ô∏è Recomendamos a√±adir m√°s meses de extracto y facturas pendientes para mejorar precisi√≥n.</p>
                {% elif snapshot.confidence_level == 'medium' %}
                    <p class="limitation-note">‚ÑπÔ∏è An√°lisis √∫til pero mejorable. Considera a√±adir facturas pendientes para mayor detalle.</p>
                {% else %}
                    <p class="limitation-note positive">‚úÖ An√°lisis fiable con datos suficientes.</p>
                {% endif %}
            </div>
            
            <div class="limitation-item">
                <strong>Qu√© NO incluye este an√°lisis:</strong>
                <ul class="limitations-list">
                    <li>Proyectos en negociaci√≥n (solo incluye facturas emitidas)</li>
                    <li>Cambios futuros en estructura de costes</li>
                    <li>Eventos excepcionales no reflejados en datos</li>
                    <li>Acceso autom√°tico a cuentas bancarias (datos manuales)</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Warnings (if any) -->
    {% if snapshot.warnings %}
    <div class="warnings-section">
        <h4>‚ö†Ô∏è Avisos de Calidad de Datos</h4>
        <ul class="warnings-list">
            {% for warning in snapshot.warnings[:5] %}
                <li>{{ warning }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Executive Summary Cards -->
    <div class="summary-cards">
        <div class="card card-balance">
            <h4>üí∞ Saldo M√≠nimo</h4>
            <div class="card-value {% if snapshot.kpis.min_balance < 0 %}negative{% endif %}">
                {{ "%.2f" | format(snapshot.kpis.min_balance) }}‚Ç¨
            </div>
            <small>Fecha: {{ snapshot.kpis.min_balance_date }}</small>
        </div>

        <div class="card card-risk">
            <h4>üö¶ Nivel de Riesgo</h4>
            <div class="card-value risk-{{ snapshot.kpis.risk_level }}">
                {{ snapshot.kpis.risk_level | upper }}
            </div>
            <small>Runway: {{ snapshot.kpis.runway_weeks }} semanas</small>
        </div>

        <div class="card card-capital">
            <h4>üíµ Capital Necesario</h4>
            <div class="card-value">
                {{ "%.2f" | format(snapshot.survival.capital_total_needed) }}‚Ç¨
            </div>
            <small>Para {{ snapshot.inputs.horizon_months }} meses</small>
        </div>

        <div class="card card-bridge">
            <h4>üåâ Financiaci√≥n Puente</h4>
            <div class="card-value">
                {{ "%.2f" | format(snapshot.survival.financiacion_puente_needed) }}‚Ç¨
            </div>
            {% if snapshot.survival.credit_gap > 0 %}
                <small class="negative">‚ùå Falta: {{ "%.2f" | format(snapshot.survival.credit_gap) }}‚Ç¨</small>
            {% else %}
                <small class="positive">‚úÖ Suficiente</small>
            {% endif %}
        </div>
    </div>

    <!-- Cashflow Table -->
    <div class="section">
        <h3>üíπ Proyecci√≥n de Cashflow</h3>
        <div class="table-container">
            <table class="cashflow-table">
                <thead>
                    <tr>
                        <th>Per√≠odo</th>
                        <th>Ingresos</th>
                        <th>Pagos</th>
                        <th>Neto</th>
                        <th>Balance</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in cashflow[:20] %}
                    <tr {% if row.balance < 0 %}class="negative-balance"{% elif row.below_safety %}class="warning-balance"{% endif %}>
                        <td>{{ row.period_start[:10] }}</td>
                        <td class="positive">+{{ "%.2f" | format(row.inflows) }}‚Ç¨</td>
                        <td class="negative">-{{ "%.2f" | format(row.outflows) }}‚Ç¨</td>
                        <td {% if row.net < 0 %}class="negative"{% else %}class="positive"{% endif %}>
                            {{ "%.2f" | format(row.net) }}‚Ç¨
                        </td>
                        <td class="balance-cell">{{ "%.2f" | format(row.balance) }}‚Ç¨</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if cashflow|length > 20 %}
            <p class="table-note">Mostrando primeros 20 per√≠odos de {{ cashflow|length }} totales</p>
        {% endif %}
    </div>

    <!-- Survival Analysis -->
    <div class="section survival-section">
        <h3>üéØ An√°lisis de Supervivencia ({{ snapshot.inputs.horizon_months }} meses)</h3>
        <div class="survival-grid">
            <div class="survival-item">
                <strong>D√©ficit Proyectado:</strong>
                <span class="{% if snapshot.survival.deficit > 0 %}negative{% endif %}">
                    {{ "%.2f" | format(snapshot.survival.deficit) }}‚Ç¨
                </span>
            </div>
            <div class="survival-item">
                <strong>Buffer Estructural Recomendado:</strong>
                <span>{{ "%.2f" | format(snapshot.survival.structural_buffer) }}‚Ç¨</span>
            </div>
            <div class="survival-item">
                <strong>Capital Propio Sugerido:</strong>
                <span>{{ "%.2f" | format(snapshot.survival.capital_propio_recommended) }}‚Ç¨</span>
            </div>
            <div class="survival-item">
                <strong>Financiaci√≥n Puente Necesaria:</strong>
                <span>{{ "%.2f" | format(snapshot.survival.financiacion_puente_needed) }}‚Ç¨</span>
            </div>
            
            {% if snapshot.survival.credit_line_total > 0 %}
            <div class="survival-item">
                <strong>L√≠nea de Cr√©dito Disponible:</strong>
                <span>{{ "%.2f" | format(snapshot.survival.credit_available) }}‚Ç¨</span>
            </div>
            <div class="survival-item">
                <strong>¬øSuficiente?:</strong>
                <span class="{% if snapshot.survival.credit_sufficient %}positive{% else %}negative{% endif %}">
                    {{ "S√ç ‚úì" if snapshot.survival.credit_sufficient else "NO ‚úó" }}
                </span>
            </div>
            
            {% if snapshot.survival.credit_gap > 0 %}
            <div class="survival-item gap-warning">
                <strong>‚ö†Ô∏è BRECHA DE FINANCIACI√ìN:</strong>
                <span class="negative">{{ "%.2f" | format(snapshot.survival.credit_gap) }}‚Ç¨</span>
            </div>
            {% endif %}
            {% endif %}
        </div>
    </div>

    <!-- Scenarios Comparison -->
    <div class="section">
        <h3>üîÆ Comparaci√≥n de Escenarios</h3>
        <div class="table-container">
            <table class="scenarios-table">
                <thead>
                    <tr>
                        <th>Escenario</th>
                        <th>Saldo M√≠n.</th>
                        <th>Riesgo</th>
                        <th>Runway</th>
                        <th>Capital Necesario</th>
                        <th>Fin. Puente</th>
                        <th>Brecha</th>
                    </tr>
                </thead>
                <tbody>
                    {% for scenario in scenarios_comparison %}
                    <tr>
                        <td><strong>{{ scenario.scenario }}</strong></td>
                        <td class="{% if scenario.min_balance < 0 %}negative{% endif %}">
                            {{ "%.2f" | format(scenario.min_balance) }}‚Ç¨
                        </td>
                        <td class="risk-{{ scenario.risk_level }}">{{ scenario.risk_level | upper }}</td>
                        <td>{{ scenario.runway_weeks }}s</td>
                        <td>{{ "%.2f" | format(scenario.capital_needed) }}‚Ç¨</td>
                        <td>{{ "%.2f" | format(scenario.bridge_financing) }}‚Ç¨</td>
                        <td class="{% if scenario.credit_gap > 0 %}negative{% endif %}">
                            {{ "%.2f" | format(scenario.credit_gap) }}‚Ç¨
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Alerts -->
    <div class="section">
        <h3>üö® Alertas Detectadas</h3>
        {% if snapshot.alerts %}
            <div class="alerts-list">
                {% for alert in snapshot.alerts %}
                <div class="alert-item severity-{{ alert.severity }}">
                    <div class="alert-header">
                        <span class="alert-badge">{{ alert.severity | upper }}</span>
                        <h4>{{ alert.title }}</h4>
                    </div>
                    <p class="alert-message">{{ alert.message }}</p>
                    <p class="alert-evidence"><em>Evidencia: {{ alert.evidence }}</em></p>
                    <p class="alert-action"><strong>‚Üí Acci√≥n recomendada:</strong> {{ alert.recommended_action }}</p>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="no-alerts">‚úÖ No se detectaron alertas cr√≠ticas en este momento.</p>
        {% endif %}
    </div>

    <!-- Action Plan -->
    <div class="section">
        <h3>üìã Plan de Acci√≥n Priorizado</h3>
        
        <div class="action-plan">
            <div class="action-timeframe">
                <h4>üî¥ Inmediato (48 horas)</h4>
                <ul>
                    {% for action in snapshot.action_plan.immediate_48h %}
                    <li>
                        <strong>{{ action.action }}</strong>
                        <br><small>Raz√≥n: {{ action.reason }}</small>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <div class="action-timeframe">
                <h4>üü° Corto Plazo (7-14 d√≠as)</h4>
                <ul>
                    {% for action in snapshot.action_plan.short_term_7_14d %}
                    <li>
                        <strong>{{ action.action }}</strong>
                        <br><small>Raz√≥n: {{ action.reason }}</small>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <div class="action-timeframe">
                <h4>üü¢ Mediano Plazo (30-90 d√≠as)</h4>
                <ul>
                    {% for action in snapshot.action_plan.medium_term_30_90d %}
                    <li>
                        <strong>{{ action.action }}</strong>
                        <br><small>Raz√≥n: {{ action.reason }}</small>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <!-- LLM Report -->
    <div class="section report-section">
        <h3>üìÑ Informe Ejecutivo
            {% if snapshot.report_source == 'llm' %}
                <span class="badge badge-llm">Generado con IA</span>
            {% else %}
                <span class="badge badge-rules">An√°lisis Rules-Based</span>
            {% endif %}
        </h3>
        <div class="report-content markdown-content">
            {{ current_report | safe }}
        </div>
    </div>

    <!-- Guided Questions (Post-Analysis) -->
    <div class="section refine-section">
        <h3>üéØ Refinar Recomendaciones</h3>
        <p>Responde estas preguntas para personalizar el informe (sin cambiar n√∫meros):</p>
        
        <form action="{{ url_for('refine', snapshot_id=snapshot.snapshot_id) }}" method="post" class="refine-form">
            
            <div class="form-group">
                <label><strong>¬øCu√°les son tus prioridades actuales? (selecciona todas las que apliquen)</strong></label>
                <div class="checkbox-grid">
                    <label><input type="checkbox" name="priorities" value="supervivencia"> Supervivencia inmediata</label>
                    <label><input type="checkbox" name="priorities" value="crecimiento"> Crecimiento</label>
                    <label><input type="checkbox" name="priorities" value="estabilidad"> Estabilidad financiera</label>
                    <label><input type="checkbox" name="priorities" value="reducir_deuda"> Reducir deuda</label>
                </div>
            </div>

            <div class="form-group">
                <label><strong>¬øC√≥mo ves el timing de tus cobros?</strong></label>
                <select name="timing">
                    <option value="">Selecciona...</option>
                    <option value="puntual">Clientes pagan puntualmente</option>
                    <option value="retrasos_leves">Retrasos leves habituales (+7-15 d√≠as)</option>
                    <option value="retrasos_graves">Retrasos graves habituales (+30 d√≠as o m√°s)</option>
                    <option value="impredecible">Muy impredecible</option>
                </select>
            </div>

            <div class="form-group">
                <label><strong>¬øCu√°nto control sientes sobre tus flujos de caja?</strong></label>
                <div class="radio-group">
                    <label><input type="radio" name="control" value="alto"> Alto control</label>
                    <label><input type="radio" name="control" value="medio"> Control medio</label>
                    <label><input type="radio" name="control" value="bajo"> Bajo control</label>
                </div>
            </div>

            {% if snapshot.kpis.risk_level == 'high' %}
            <div class="form-group">
                <label><strong>¬øHay cobros o pagos grandes pr√≥ximos no reflejados en los datos?</strong></label>
                <textarea name="upcoming_cashflows" rows="3" 
                          placeholder="ej. 'Cobro de 20k‚Ç¨ esperado en 15 d√≠as, pago de impuestos de 10k‚Ç¨ en 30 d√≠as'"></textarea>
            </div>
            {% endif %}

            {% if snapshot.survival.financiacion_puente_needed > 0 %}
            <div class="form-group">
                <label><strong>¬øPuedes renegociar t√©rminos de pago con proveedores?</strong></label>
                <div class="radio-group">
                    <label><input type="radio" name="can_renegotiate" value="si"> S√≠</label>
                    <label><input type="radio" name="can_renegotiate" value="no"> No</label>
                    <label><input type="radio" name="can_renegotiate" value="algunos"> Algunos</label>
                </div>
            </div>
            {% endif %}

            <button type="submit" class="btn btn-secondary">üîÑ Actualizar Informe con Mis Respuestas</button>
        </form>
    </div>

    <!-- Downloads -->
    <div class="section downloads-section">
        <h3>üíæ Descargas</h3>
        <div class="download-buttons">
            <a href="{{ url_for('download', snapshot_id=snapshot.snapshot_id, file_type='txt') }}" 
               class="btn btn-download">üìÑ Descargar Informe TXT</a>
            <a href="{{ url_for('download', snapshot_id=snapshot.snapshot_id, file_type='md') }}" 
               class="btn btn-download">üìù Descargar Informe MD</a>
            <a href="{{ url_for('download', snapshot_id=snapshot.snapshot_id, file_type='csv_cashflow') }}" 
               class="btn btn-download">üìä Descargar Cashflow CSV</a>
            <a href="{{ url_for('download', snapshot_id=snapshot.snapshot_id, file_type='csv_scenarios') }}" 
               class="btn btn-download">üîÆ Descargar Escenarios CSV</a>
        </div>
    </div>

    <!-- Navigation -->
    <div class="section navigation-section">
        <a href="{{ url_for('index') }}" class="btn btn-primary">üÜï Nuevo An√°lisis</a>
        <a href="{{ url_for('history') }}" class="btn btn-secondary">üìö Ver Historial</a>
    </div>
</div>
{% endblock %}
