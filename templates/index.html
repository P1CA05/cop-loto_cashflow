{% extends "base.html" %}

{% block title %}Inicio - Copiloto Cashflow{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-white py-3">
                <h4 class="mb-0 text-primary"><i class="fas fa-calculator me-2"></i>Nuevo Análisis Financiero</h4>
            </div>
            <div class="card-body p-4">
                <form action="{{ url_for('analyze') }}" method="post" enctype="multipart/form-data" id="analysisForm">
                    
                    <h5 class="text-secondary mb-3">1. Situación Actual</h5>
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <label for="starting_balance" class="form-label">Saldo Actual en Banco (€) *</label>
                            <div class="input-group">
                                <span class="input-group-text">€</span>
                                <input type="number" step="0.01" class="form-control" id="starting_balance" name="starting_balance" required placeholder="0.00">
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="horizon_months" class="form-label">Horizonte de Proyección</label>
                            <select class="form-select" id="horizon_months" name="horizon_months">
                                <option value="3">3 Meses</option>
                                <option value="6" selected>6 Meses</option>
                                <option value="12">12 Meses</option>
                            </select>
                        </div>
                    </div>

                    <h5 class="text-secondary mb-3">2. Importación de Datos</h5>
                    <div class="mb-4">
                        <div class="mb-3">
                            <label for="bank_file" class="form-label">Extracto Bancario (CSV/Excel) *</label>
                            <input class="form-control" type="file" id="bank_file" name="bank_file" accept=".csv,.xlsx,.xls" required>
                            <div class="form-text">Histórico de movimientos para detectar patrones.</div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="sales_invoices_file" class="form-label">Facturas Emitidas (Opcional)</label>
                                <input class="form-control" type="file" id="sales_invoices_file" name="sales_invoices_file" accept=".csv,.xlsx,.xls">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="purchase_invoices_file" class="form-label">Facturas Recibidas (Opcional)</label>
                                <input class="form-control" type="file" id="purchase_invoices_file" name="purchase_invoices_file" accept=".csv,.xlsx,.xls">
                            </div>
                        </div>
                    </div>

                    <div class="accordion mb-4" id="accordionAdvanced">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAdvanced">
                                    <i class="fas fa-sliders-h me-2"></i> Configuración Avanzada
                                </button>
                            </h2>
                            <div id="collapseAdvanced" class="accordion-collapse collapse" data-bs-parent="#accordionAdvanced">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Gastos Fijos Mensuales (€)</label>
                                            <input type="number" step="0.01" class="form-control" name="fixed_costs_monthly">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Umbral de Seguridad (€)</label>
                                            <input type="number" step="0.01" class="form-control" name="safety_threshold" value="1000">
                                            <div class="form-text">Mínimo saldo deseado en cuenta.</div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Línea de Crédito Total (€)</label>
                                            <input type="number" step="0.01" class="form-control" name="credit_line_total">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Crédito Usado (€)</label>
                                            <input type="number" step="0.01" class="form-control" name="credit_line_used">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Granularidad de Análisis</label>
                                            <select class="form-select" name="granularity">
                                                <option value="daily">Diaria</option>
                                                <option value="weekly" selected>Semanal (recomendado)</option>
                                                <option value="monthly">Mensual</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" id="conservative_mode" name="conservative_mode">
                                        <label class="form-check-label" for="conservative_mode">Modo Conservador (Pesimista)</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="btnAnalyze">
                            <span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                            <i class="fas fa-search-dollar me-2"></i>Generar Análisis
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('analysisForm').addEventListener('submit', function(e) {
        var btn = document.getElementById('btnAnalyze');
        var originalContent = btn.innerHTML;
        btn.disabled = true;
        btn.querySelector('.spinner-border').classList.remove('d-none');
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Analizando...';
        
        // Store original content in case we need to restore it
        btn.setAttribute('data-original', originalContent);
    });
</script>
{% endblock %}
