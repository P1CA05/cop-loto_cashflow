{% extends "base.html" %}

{% block content %}

<!-- Hero Section -->
<div class="hero-section">
    <h1>An√°lisis Financiero Inteligente</h1>
    <p>Proyecta tu cashflow y obt√©n recomendaciones accionables para la supervivencia de tu PYME</p>
</div>

<form action="{{ url_for('analyze') }}" method="post" enctype="multipart/form-data">
    
    <!-- Card: Informaci√≥n B√°sica -->
    <div class="card-modern">
        <div class="card-header">Informaci√≥n B√°sica</div>
        
        <div class="form-group">
            <label class="form-label" for="starting_balance">Saldo Actual Disponible (‚Ç¨) *</label>
            <input type="number" step="0.01" name="starting_balance" id="starting_balance" 
                   class="form-control" required placeholder="Ej: 15000.00">
            <small style="color: var(--text-muted);">Tu saldo en banco disponible hoy</small>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label" for="horizon_months">Horizonte de Proyecci√≥n *</label>
                <select name="horizon_months" id="horizon_months" class="form-select" required>
                    <option value="3">3 meses</option>
                    <option value="6" selected>6 meses (recomendado)</option>
                    <option value="9">9 meses</option>
                    <option value="12">12 meses</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="granularity">Granularidad</label>
                <select name="granularity" id="granularity" class="form-select">
                    <option value="daily">Diaria</option>
                    <option value="weekly" selected>Semanal (recomendado)</option>
                    <option value="monthly">Mensual</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label" for="bank_file">Extracto Bancario (CSV o Excel) *</label>
            <div class="file-upload-area" onclick="document.getElementById('bank_file').click()">
                <span class="file-upload-icon">üìÑ</span>
                <div class="file-upload-text">Arrastra tu archivo aqu√≠</div>
                <div class="file-upload-hint">o haz clic para seleccionar</div>
                <button type="button" class="file-upload-button">Seleccionar archivo</button>
                <input type="file" name="bank_file" id="bank_file" accept=".csv,.xlsx,.xls" 
                       required style="display: none;">
                <div id="bank_file_name" class="file-selected" style="display: none;"></div>
            </div>
            <small style="color: var(--text-muted);">Movimientos bancarios hist√≥ricos. 
                <a href="{{ url_for('help_page') }}#templates" target="_blank">Ver formato</a>
            </small>
        </div>
    </div>

    <!-- Card: Datos Adicionales -->
    <div class="card-modern">
        <div class="card-header">Datos Adicionales</div>
        
        <div class="form-group">
            <label class="form-label" for="fixed_costs_monthly">Gastos Fijos Mensuales (‚Ç¨)</label>
            <input type="number" step="0.01" name="fixed_costs_monthly" id="fixed_costs_monthly" 
                   class="form-control" placeholder="Ej: 5000.00">
            <small style="color: var(--text-muted);">N√≥minas, alquiler, suscripciones fijas</small>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label" for="sales_invoices_file">Facturas Emitidas</label>
                <div class="file-upload-area" onclick="document.getElementById('sales_invoices_file').click()" style="padding: 1.5rem;">
                    <span class="file-upload-icon" style="font-size: 2rem;">üí∞</span>
                    <div class="file-upload-text" style="font-size: 0.9rem;">Facturas pendientes de cobro</div>
                    <input type="file" name="sales_invoices_file" id="sales_invoices_file" 
                           accept=".csv,.xlsx,.xls" style="display: none;">
                    <div id="sales_file_name" class="file-selected" style="display: none;"></div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="purchase_invoices_file">Facturas Recibidas</label>
                <div class="file-upload-area" onclick="document.getElementById('purchase_invoices_file').click()" style="padding: 1.5rem;">
                    <span class="file-upload-icon" style="font-size: 2rem;">üìã</span>
                    <div class="file-upload-text" style="font-size: 0.9rem;">Facturas pendientes de pago</div>
                    <input type="file" name="purchase_invoices_file" id="purchase_invoices_file" 
                           accept=".csv,.xlsx,.xls" style="display: none;">
                    <div id="purchase_file_name" class="file-selected" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Card: L√≠nea de Cr√©dito -->
    <div class="card-modern">
        <div class="card-header">üí≥ L√≠nea de Cr√©dito</div>
        
        <div class="form-row">
            <div class="form-group">
                <label class="form-label" for="credit_line_total">L√≠nea de Cr√©dito Total (‚Ç¨)</label>
                <input type="number" step="0.01" name="credit_line_total" id="credit_line_total" 
                       class="form-control" placeholder="Ej: 50000.00">
            </div>

            <div class="form-group">
                <label class="form-label" for="credit_line_used">Cr√©dito Usado Actualmente (‚Ç¨)</label>
                <input type="number" step="0.01" name="credit_line_used" id="credit_line_used" 
                       class="form-control" placeholder="Ej: 10000.00">
            </div>
        </div>

        <div class="form-group">
            <label class="form-label" for="interest_rate">Inter√©s Anual Estimado (%)</label>
            <input type="number" step="0.01" name="interest_rate" id="interest_rate" 
                   class="form-control" placeholder="Ej: 5.5">
            <small style="color: var(--text-muted);">Para estimar coste de uso de cr√©dito</small>
        </div>
    </div>

    <!-- Card: Configuraci√≥n Avanzada -->
    <div class="card-modern">
        <div class="card-header">‚öôÔ∏è Configuraci√≥n Avanzada</div>
        
        <div class="form-group">
            <label class="form-label" for="safety_threshold">Umbral de Seguridad (‚Ç¨)</label>
            <input type="number" step="0.01" name="safety_threshold" id="safety_threshold" 
                   class="form-control" placeholder="Ej: 5000.00">
            <small style="color: var(--text-muted);">Saldo m√≠nimo que quieres mantener como colch√≥n</small>
        </div>
    </div>

    <!-- Bot√≥n de env√≠o -->
    <div style="text-align: center; margin-top: 2rem;">
        <button type="submit" class="btn-modern btn-modern-primary" style="font-size: 1.1rem; padding: 1rem 3rem;">
            üöÄ Analizar Cashflow
        </button>
    </div>
</form>

<script>
// File upload handlers con feedback visual
document.getElementById('bank_file').addEventListener('change', function(e) {
    const fileName = e.target.files[0]?.name;
    const display = document.getElementById('bank_file_name');
    if (fileName) {
        display.textContent = '‚úì ' + fileName;
        display.style.display = 'inline-block';
    }
});

document.getElementById('sales_invoices_file').addEventListener('change', function(e) {
    const fileName = e.target.files[0]?.name;
    const display = document.getElementById('sales_file_name');
    if (fileName) {
        display.textContent = '‚úì ' + fileName;
        display.style.display = 'inline-block';
    }
});

document.getElementById('purchase_invoices_file').addEventListener('change', function(e) {
    const fileName = e.target.files[0]?.name;
    const display = document.getElementById('purchase_file_name');
    if (fileName) {
        display.textContent = '‚úì ' + fileName;
        display.style.display = 'inline-block';
    }
});

// Drag & Drop functionality
['bank_file', 'sales_invoices_file', 'purchase_invoices_file'].forEach(id => {
    const input = document.getElementById(id);
    const area = input.closest('.file-upload-area');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        area.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        area.addEventListener(eventName, () => area.classList.add('drag-over'), false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        area.addEventListener(eventName, () => area.classList.remove('drag-over'), false);
    });
    
    area.addEventListener('drop', function(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        input.files = files;
        const event = new Event('change');
        input.dispatchEvent(event);
    });
});
</script>

{% endblock %}
